# ImageProcessor

Сервис фоновой обработки изображений с очередью задач, воркером и простым интерфейсом.

## Описание

ImageProcessor:
- принимает изображения от пользователя:
   - по одному на ресайз и генерацию тамбнейла,
   - 2 - для наложения ватермарка, 
- сохраняет оригинал(-ы), 
- ставит задачу в очередь на обработку,
- валидирует входящее изображение и асинхронно выполняет преобразования:
    - изменение размера, 
    - добавление водяного знака,
    - генерацию тамбнейла. 

Результаты сохраняются в объектное хранилище и становятся доступны через HTTP.
Фактически проект содержит 2 приложения:
- API-приложение - внутри него реализована:
    - серверная api-часть, 
    - бизнес-логика, 
    - логирование HTTP-запросов, 
    - чтение/запись в БД/S3,
    - инициализация очереди,
    - фоновая горутина, отслеживающия и публикующая заново в кафку зависшие задачи,
- Worker-приложение:
    - читает сообщения от кафки,
    - запрашивает из БД полную информацию о задаче,
    - выполняет саму задачу и кладет результат в БД/S3.

Оба приложения реализованы с Graceful Shutdown, логикой ретраев инициализации БД/S3/Kafka.

## Стек

- Golang,
- MinIO в качестве S3-хранилища файлов,
- Postgres в качестве БД,
- Kafka(Kraft-режим) как брокер сообщений,
- HTML + JS (без фреймворков)
- Docker compose для поднятия всего приложения.

## Архитектура

```
HTTP (server)
   ↓
Logger (Zlog)
   ↓
HTTP (handlers)
   ↓
Service (бизнес‑логика) → Storage (PostgreSQL / MinIO)
   ↓
Queue (kafka)
   ↓
Worker (фоновая обработка)
```

### Основные компоненты/слои

* **transport/** - HTTP‑хендлеры и вспомогательные функции для валидации входящих параметров
* **service/** - бизнес‑логика обработки изображений
* **storage/** - абстракция хранилища
* **miniostorage/** - реализация объектного хранилища
* **kafka/** - реализация очереди сообщений
* **repository/** - абстракция БД
* **imgpostgres/** - реализация БД
* **imageproc/** - обработчики изображений
* **mwlogger/** - логгер для HTTP-реквестов, инжектится в контекст
* **worker/** - фоновый обработчик задач
* **web/** - простой HTML/JS‑интерфейс


## Запуск проекта

### Конфигурация

Создать файл окружения из примера(скопировать и переименовать), внести в него необходимые правки:

```bash
cp .env.example .env
```

### Запуск

```bash
docker-compose up
```
Docker-compose билдит 2 независимых бинарника - api и worker - в один образ, 
запускаются они как 2 отдельных контейнера.

После запуска:

* Web UI будет доступен по адресу: `http://localhost:8080/web`
* API - на том же хосте.

## Использование

* Загрузить изображение через форму
* Дождаться завершения обработки (обновленный список задач загружается раз в 2 секунды)
* Просмотреть результат
* Удалить изображение при необходимости

## Тестирование

Запуск всех тестов:

```bash
go test ./...
```


## Статусы обработки

* `created` — изображение загружено
* `in_progress` — находится в обработке
* `done` — обработка завершена
* `failed` — ошибка обработки

## Идеи для развития

* Добавить ретраи и DLQ для задач, которые воркер не смог обработать за n-попыток;
* TTL для задач и файлов в бд/хранилище;
* Авторизация и привязка изображений/задач к пользователям;
* Добавить в ридми примеры корректных запросов к эндпоинтам, или вообще оформить их в Swagger.



